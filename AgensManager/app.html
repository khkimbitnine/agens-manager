<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Sidebar Test</title>
<link href="public/css/mbExtruder.css" media="all" rel="stylesheet"
	type="text/css">
<link rel="stylesheet" href="public/css/jquery.treeview.css" />
<link rel="stylesheet" href="public/css/style.css" />
</head>
<body>
	<div class="wrapper">
		<div class="longText" style="position: relative; padding-left: 50px">
			<div id="extruderLeft" class="{title:'Functions', url:''}">
				<div id="tw" class="voice {panel:''}">
					<a class="label" href="" target="_blank">Create</a>
				</div>
			</div>
			<div id="extruderLeft1" class="a {title:'Object Browser', url:''}">
				<div id="tw" class="voice {panel:''}">Create</div>
				<div id="main">
					<div id="date"></div>
					<ul id="browser" class="filetree">
					</ul>
				</div>
				<!-- main end -->
			</div>
		</div>
	</div>
	<script type="text/javascript"
		src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
	<script type="text/javascript"
		src="public/js/jquery.hoverIntent.min.js"></script>
	<script type="text/javascript" src="public/js/jquery.mb.flipText.js"></script>
	<script type="text/javascript" src="public/js/mbExtruder.js"></script>
	<script type="text/javascript" src="public/js/jquery.treeview.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.3.3.js"></script>
	<script type="text/javascript">
		$("#extruderLeft").buildMbExtruder({
			position : "left",
			width : 230,
			extruderOpacity : .8,
			hidePanelsOnClose : true,
			accordionPanels : true,
		});

		$("#extruderLeft1").buildMbExtruder({
			position : "left",
			width : 230,
			extruderOpacity : .8,
		});

		var s = $("#browser").treeview({
			collapsed : true
		});
		//======================= 트리 생성 ===============================

		//========= 소켓 연결
		var socket = io.connect();
		//========= 트리전체를 감싸는 #browser 선언
		var $browser = $("#browser");
		//========= db 트리 생성
		socket
				.on(
						'db',
						function(data) {
							for (var i = 0; i < data.db.length; i++) {
								//alert(data.db[i]);
								$(
										"<li class='expandable lastExpandable'><div class='hitarea expandable-hitarea lastExpandable-hitarea'></div><span class='folder db'>"
												+ data.db[i] + "</span></li>")
										.appendTo($browser);
							}
							socket.removeListener('db');
						});
		//========= db 클릭, 스키마 생성             
		$browser.on("click", ".db", function() {
			var $this = $(this);//db
			var dbname = $this.text();

			if ($this.parent().hasClass("collapsable")) {
				$this.next().remove();
				$this.prev().removeClass().addClass(
						"expandable-hitarea lastExpandable-hitarea");
				$this.parent().removeClass().addClass(
						"expandable lastExpandable");
			} else {
				$this.prev().removeClass().addClass(
						"collapsable-hitarea lastCollapsable-hitarea");
				$this.parent().removeClass().addClass(
						"collapsable lastCollapsable");

				//스키마 출력 함수 호출
				schname_emit(dbname, $this);
			}
		});

		//스키마 출력 함수(인자: dbname은 db이름, thisDb는 객체)
		function schname_emit(dbname, thisDb) {
			console.log(thisDb.text());

			//db이름 전송
			socket.emit('set_dbname', dbname);

			//스키마 수신
			socket.once('scname', function(data) {//이벤트 리스너 해제를 확실히 하기 위해서, once 메서드(한번만 리스너 실행)를 씀.(다른 리스너들은 on을 써도 작동됨)

				if (data.schema != 0) {//접속한 db와 dbname이 일치하지 않을 때 0으로 리턴되면 실행하지 않음.
					var clickedDb = thisDb;

					//스키마 배열 생성 함수 호출
					sch_name(data, clickedDb);
					console.log("clicked: " + clickedDb.text());

					//스키마 수신 이벤트 리스너 해제
					socket.removeListener('scname');
				}
			});

			//스키마 배열 생성 함수(data = 스키마 데이터, clickedDb = 클릭한 db 객체(=thisDb))
			function sch_name(data, clickedDb) {
				$("<ul style='display: block;' class='sch'>").insertAfter(
						clickedDb);
				console.log(clickedDb.text());
				for (var i = 0; i < data.schema.length; i++) {
					$(
							"<li class='last'><span class='file schema'>"
									+ data.schema[i] + "</span></li>")
							.appendTo(clickedDb.next());
				}
			}
		}

		//========= 스키마 클릭, 테이블 생성             
		$browser.on("click", ".schema", function() {
			var $this = $(this);//schema
			var scname = $this.text();
			if ($this.next().hasClass("tab")) {
				$this.next().remove();
				$this.prev().removeClass().addClass(
						"expandable-hitarea lastExpandable-hitarea");
				$this.parent().removeClass().addClass(
						"expandable lastExpandable");
			} else {
				$("<ul style='display: block;' class='tab'>")
						.insertAfter($this);
				$this.prev().removeClass().addClass(
						"collapsable-hitarea lastCollapsable-hitarea");
				$this.parent().removeClass().addClass(
						"collapsable lastCollapsable");

				//테이블 출력 함수 호출
				tabname_emit(scname, $this);
			}
		});

		//테이블 출력 함수 (scname = 스키마 이름, thisSchema = 스키마 객체)
		function tabname_emit(scname, thisSchema) {

			//스키마 이름 전송
			socket.emit('set_scname', scname);

			//테이블 수신
			socket.on('tabname', function(data) {
				//테이블 배열 생성 함수 호출
				tab_name(data);
			});
			
			//테이블 배열 생성 함수 (data = 테이블 데이터)
			function tab_name(data) {
				console.log(data);
				for (var i = 0; i < data.table.length; i++) {
					console.log(data.table[i]);
					$(
							"<li class='last'><span class='file table'>"
									+ data.table[i] + "</span></li>").appendTo(
							thisSchema.next());
				}
				//테이블 수신 이벤트 리스너 해제
				socket.removeListener('tabname');
			}
		}

		//========= 테이블 클릭, 컬럼 생성
		$browser.on("click", ".table", function() {
			var $this = $(this);//table
			var tabname = $this.text();
			var scname = $this.parents(".tab").prev().text();
			if ($this.next().hasClass("col")) {
				$this.next().remove();
				$this.prev().removeClass().addClass(
						"expandable-hitarea lastExpandable-hitarea");
				$this.parent().removeClass().addClass(
						"expandable lastExpandable");
			} else {
				$("<ul style='display: block;' class='col'>")
						.insertAfter($this);
				$this.prev().removeClass().addClass(
						"collapsable-hitarea lastCollapsable-hitarea");
				$this.parent().removeClass().addClass(
						"collapsable lastCollapsable");
				// 컬럼 출력 함수 호출
				colname_emit(tabname, scname, $this);
			}
		});
		
		//컬럼 출력 함수 (tab = 테이블 이름, sc = 스키마 이름, $this = 테이블 객체)
		function colname_emit(tab, sc, $this) {
			
			//테이블 이름 전송
			socket.emit('set_tabname', {
				tabname : tab,
				table_scname : sc
			});
			
			//컬럼 수신
			socket.on('colname', function(data) {
				console.log("data: " + data);
				//컬럼 배열 생성 함수 호출
				col_name(data, $this);
			});
		}
		
		//컬럼 배열 생성 함수 (data = 컬럼 데이터, $this = 테이블 객체)
		function col_name(data, $this) {

			for (var i = 0; i < data.column.length; i++) {
				console.log(data.column[i]);
				$(
						"<li class='last'><span class='file column'>"
								+ data.column[i] + "</span></li>").appendTo(
						$this.next());
			}
			//스키마 수신 이벤트 리스너 해제
			socket.removeListener('colname');
		}
	</script>
</body>
</html>