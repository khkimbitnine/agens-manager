<link rel="stylesheet" href="/static/css/create_function.css" />
<div class="content_wrapper">
	<form id="functionForm" class="alter">
	<div>
		<div id="langBox">
			<label for="language">SQL/PLPGSQL</label><input type="radio" class="language"/>
			<label for="language">INTERNAL</label><input type="radio" class="language" />
			<label for="language">C</label><input type="radio" class="language">
		</div>
		<div id="schema">
			<label for="schemaList">SCHEMA NAME : </label> 
			<input type="hidden" name="old_scname" id="oldSc"></input>
			<select name="scname" id="schemaList">
			</select>
		</div>		
	</div>
	</form>
	<div id="btnBox">
	<button id="alterBtn">Alter</button>
	<button id="backBtn">Back</button>
	</div>
</div>
<script>
	
	$("#alterBtn").click(function(){
		validCheck();
	});
	
	// To check if input values are different, there are old values hidden
	var head_template=
		
		'<ul>'
		+ '<li id="row1">'
		+ '<label>NAME</label>'
		+ '<div id="name">'
		+ '<input type="hidden" name="old_name" />'
		+ '<input type="text" name="name" />'
		+ '</div>'
		+ '<label>ARGUMENTS : </label>'
		+ '<input type="hidden" name="arg" id="arg">'
		+ '<div id="arguments">'
		+ '</div>'
		+ '<label>RETURNS : </label>'
		+ '<input type="hidden" name="returns" id="ret">'
		+ '<div id="returns">'
		+ '</div>'
		+ '<label>PROGRAMMING LANGUAGE : </label>'
		+ '<input type="hidden" name="language" id="lang">'
		+ '<div id="language">'
		+ '</div>'
		+ '</li>';
	+ '</ul>';
	
	var sql_template = 
		
		'<ul class="temp">'
		+ '<li id="row2" class="def">'
		+ '</li>'
		+ '<li id="row3" >'
		+ '<label for="comment">COMMENT</label>'
		+ '<input type="hidden" name="old_comment" id="oldCmt" ></input>'
		+ '<textarea name="comment" id="comment" ></textarea>'
		+ '</li>'
		+ '<li id="row4" >'
		+ '<span>FUNCTION COSTING:</span>'
		+ '<ul>'
		+ '<li>'
		+ '<label for="execution_cost">Execution Cost</label>'
		+ '<input type="hidden" name="old_execution_cost" id="oldCost" />'
		+ '<input type="text" name="execution_cost" id="execution_cost" />'
		+ '</li>'
		+ '<li>'
		+ '<label for="result_rows">Result Rows</label>'
		+ '<input type="hidden" name="old_result_rows" id="oldRows"/>'
		+ '<input type="text" name="result_rows" id="result_rows"/>'
		+ '</li>'
		+ '</ul>'
		+ '</li>'
		+ '<li id="row5" >'
		+ '<span>PROPERTIES:</span>'
		+ '<input type="hidden" name="old_behavior" id="oldBehav">'
		+ '<select name="behavior" id="behavior">'
		+ '<option></option>'
		+ '<option value="IMMUTABLE">IMMUTABLE</option>'
		+ '<option value="STABLE">STABLE</option>'
		+ '<option value="VOLATILE">VOLATILE</option>'
		+ '</select>'
		+ '<input type="hidden" name="old_strict" id="oldStrict">'
		+ '<select name="strict" id="strict">'
		+ '<option></option>'
		+ '<option value="CALLED ON NULL INPUT">CALLED ON NULL INPUT</option>'
		+ '<option value="RETURNS NULL ON NULL INPUT">RETURNS NULL ON NULL INPUT</option>'
		+ '</select>'
		+ '<input type="hidden" name="old_security" id="oldSec">'
		+ '<select name="security" id="security">'
		+ '<option></option>'
		+ '<option value="SECURITY INVOKER">SECURITY INVOKER</option>'
		+ '<option value="SECURITY DEFINER">SECURITY DEFINER</option>'
		+ '</select>'
		+ '</li>'
		+ '</ul>';
	
	var $functionForm = $("#functionForm");
	
	$functionForm
	.children('div')
	.append(head_template);
	
	$functionForm.append(sql_template);
	
	var def = '<label>DEFINITION</label>'+
			  '<input type="hidden" name="old_def" id="oldDef"></input>'+
			  '<textarea name="definition" id="definition" ></textarea>';
	
	$(".def").append(def);
	
	var $row1 = $("#row1");
	var $row2 = $functionForm.find("#row2");
	
	var $row2Ul = $("#row2>ul");
	
	var $row4 = $functionForm.find("#row4");
	
	// language button
	var $sqlBtn = $("#langBox").find(".language").eq(0);
	var $internalBtn = $("#langBox").find(".language").eq(1);
	var $cBtn = $("#langBox").find(".language").eq(2);
	
	// SQL is default
	$sqlBtn.prop('checked', 'checked');
	
	// PROGRAMMING LANGUAGE
	var $lang = $row1.find("#language");
	
	// language button : sql/internal/c
	$sqlBtn.click(function(){
	
		if(!$row4.hasClass("def")){
	
			$row4.addClass("def").empty().append(def);
	
		}
	
		if(!$lang.hasClass("sql")){
	
			$lang.empty().removeClass("internal c").addClass("sql").append(sql);
		}
	});
	
	$internalBtn.click(function(){//link symbol
	
		$row2.children("ul").children("li").remove();
		
		row2append();
		
		$row4.removeClass("def")
		.empty()
		.append('<label>LINK SYMBOL</label>'+
				'<input type="text" name="link_symbol" id="linkSymbol">')
		.find('input')
		.width('970px');
		
		$lang.empty()
		.removeClass("sql c")
		.addClass("internal")
		.append('<div>'+
					'<span>internal</span>'+
					'<input type="hidden" name="language" value="internal"/>'+
				'</div>');
	
	});
	
	$cBtn.click(function(){//object file, link symbol
	
		$row2
		.children("ul")
		.children("li")
		.remove();
		
		row2append();
		
		$row4
		.removeClass("def")
		.empty()
		.append('<div class="objectFile">'+
					'<label>OBJECT FILE</label>'+
					'<input type="text" name="object_file" id="objectFile">'+
				'</div>'+
				'<div class="objectFile">'+
					'<label>LINK SYMBOL</label>'+
					'<input type="text" name="link_symbol" id="linkSymbol">'+
				'</div>')
		.find('div')
		.css({"width": "480px", 
					"display":"inline-block"})
		.children("input")
		.width("480px");
		$lang
		.empty()
		.removeClass("sql internal")
		.addClass("c")
		.append('<div>'+
					'<span>c</span>'+
					'<input type ="hidden" name="language" value="c" />'+
				'</div>');
	
	});
	
	// language should be selected only one
	$(".language").click(function(){
	
		$(".language").not($(this)).prop('checked', false);
		
		$("#dbList").find('option').eq(0).prop('selected', true);
		
		$("#functionForm .schema, #functionForm .type").empty();
	
	});
	
	var namePat = /^[a-zA-Z_][a-zA-Z_\d]+$/;
	var defPat = /^[a-zA-Z_-\d\s\.\%\/\*\+\=\(\)\"\'\!\<\>\,\:\$]+$/;
	var costPat = /^[\d]+$/;
	
	function notValid(notValid) {
		
		notValid
		.css("border", "2px solid red")
		.addClass("notValid");
		
	}
	
	// Regular expression test & empty value test
	function validCheck() {
		
		$(".notValid").removeClass("notValid").css({
			"border" : "1px solid #aaa"
		});
	
		var $name = $("#name").find('input');
		var $def = $("#definition");
		var $cmt = $("#comment");
		var $exeCst = $("#execution_cost");
		var $resRow = $("#result_rows");
		
		if (!namePat.test($name.val()) || !$name.val()){
			
			notValid($name);
			
		}
	
		if(!$def.val()){
	
			notValid($def);
	
		}
		
		if($("#language").hasClass('internal') || $("#language").hasClass('c')){
			
			var $link = $("#linkSymbol");
			
			if(!defPat.test($link.val()) || !$link.val()){
	
				notValid($link);
	
			}
		}
		
		if($("#language").hasClass('c')){
			
			var $obj = $("#objectFile");
			
			if(!defPat.test($obj.val()) || !$obj.val()){
				
				notValid($obj);
				
			}
		}
	
		if(!defPat.test($cmt.val()) && $cmt.val()){
	
			notValid($cmt);
	
		}
		if(!costPat.test($exeCst.val()) && $exeCst.val()){
	
			notValid($exeCst);
	
		}
	
		if(!costPat.test($resRow.val()) && $resRow.val()){
	
			notValid($resRow);
	
		}
	
	
		if (!$(".notValid").size()) {
			
			socket.emit("alter_proc", $("#functionForm").serializeArray());
			
			socket.once('function_success', function(error){
	
				if(error == null){
	
					alert("Function altered.");
					
					$.ajax({
						
						url:"schema_content.html",
						success:function(data){
							
							$(".content").empty().html(data);
							socket.emit('set_schema_table', $(".schema.on").text());
							$("#function").click();
						}
					});
	
				}else{
	
					alert(error);
				}
			});
		}
	
	}
	
	// Returns to proc_info
	$("#backBtn").click(function(){
			
			$.ajax({
				
				url:"schema_content.html",
				success:function(data){
					
					$(".content").empty().html(data);
					socket.emit('set_schema_table', $(".schema.on").text());
					$("#function").click();
				}
			});
			
		});
	
	</script>
