<link rel="stylesheet" href="/static/css/create_view.css" />
<div class="content_wrapper">
	<form id="viewForm">
		<div>
			<label for="name">VIEW NAME</label>
			<input type="hidden" name="old_name" id="oldName"/>
			<input type="text" name="name" id="name"/>
		</div>
		<ul id="view">
			<li class="alter">
				<label>QUERY</label>
				<input type="hidden" name="old_query" id="oldQuery" />
				<textarea name='query' id='query'></textarea>
			</li>
			<li class="alter">
				<label>COMMENT</label>
				<input type="hidden" name="old_comt" id="oldCmt" />
				<textarea name='comment' id='comment'></textarea>
			</li>
		</ul>
	</form>
	<div id="btnBox">
		<button id="alterBtn">Alter</button>
		<button id="backBtn">Back</button>
	</div>
</div>
<script>

	var $name = $("#name");
	var $query = $("#query");
	var $comment = $("#comment");
	
	var pattern = /^[a-zA-Z_-\d\s\.\%\/\*\+\=\(\)\"\'\!\<\>\,\:]+$/;
	
	var namePattern = /^[a-zA-Z_][a-zA-Z_\d]+$/;
	var onePattern = /^[a-zA-Z_]+$/;	// In case name is one character
	
	
	function notValid(notValid){
		
		notValid
		.css("border", "2px solid red")
		.addClass("notValid");
		
	}

	// Regular expression test & empty value test
	function validCheck(){
		
		$(".notValid")
		.removeClass("notValid")
		.css({"border": "1px solid #aaa"});
		
		if(!namePattern.test($name.val()) && !onePattern.test($name.val())){
			
			notValid($name);
			
		}
		
		if(!pattern.test($query.val()) || !$query.val()){
			
			notValid($query);
			
		}
		
		if(!pattern.test($comment.val()) && $comment.val()){
			
			notValid($comment);
			
		}
		
		if(!$(".notValid").size()) {
			
			socket.emit('alter_view', $("#viewForm").serializeArray());
			
			socket.once('view_success', function(error){
				
				if(error==null){
					
					alert("View altered.");
					
					$.ajax({
						
						url:"schema_content.html",
						success:function(data){
							
							$(".content").empty().html(data);
							socket.emit('set_schema_table', $(".schema.on").text());
							$("#view").click();	
						}
					});
					
				}else{
					
					alert(error);
				}
			});
		}
		
	}

	$("#alterBtn").click(function(e){
		
		e.preventDefault();
		validCheck();
		
	});
	
	// Returns to view_info
	$("#backBtn").click(function(){
		
		$.ajax({
			
			url:"schema_content.html",
			success:function(data){
				
				$(".content").empty().html(data);
				socket.emit('set_schema_table', $(".schema.on").text());
				$("#view").click();
			}
		});
		
	});

</script>
